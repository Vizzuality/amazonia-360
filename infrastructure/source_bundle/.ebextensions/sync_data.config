commands:
  install_awscli:
    command: |
      sudo apt-get update -y
      sudo apt-get install -y awscli
      sudo apt-get clean
      sudo rm -rf /var/lib/apt/lists/*

  create_data_folder:
    command: mkdir -p /var/app/data/api

  sync_s3_bucket:
    command: aws s3 sync ${AWS_BUCKET_NAME} /var/app/data/api

  create_sync_script:
      command: |
        cat <<'SCRIPT' > /usr/local/bin/sync_s3_data.sh
        #!/bin/bash

        # Log file for sync operations
        LOG_FILE="/var/log/s3_sync.log"

        # Function to log with timestamp
        log_message() {
            echo "[\$(date '+%Y-%m-%d %H:%M:%S')] \$1" >> \$LOG_FILE
        }

        log_message "Starting S3 sync..."

        # Sync S3 bucket to local directory
        if aws s3 sync ${AWS_BUCKET_NAME} /var/app/data/api >> \$LOG_FILE 2>&1; then
            log_message "S3 sync completed successfully"
        else
            log_message "S3 sync failed with exit code \$?"
        fi
        SCRIPT

        chmod +x /usr/local/bin/sync_s3_data.sh

  setup_cron_job:
    command: |
      # Create cron job to sync every 10 minutes
      echo "*/10 * * * * root /usr/local/bin/sync_s3_data.sh" > /etc/cron.d/s3-sync
      chmod 0644 /etc/cron.d/s3-sync

      # Ensure cron service is running
      sudo service cron start
      sudo systemctl enable cron

      # Create log file with proper permissions
      sudo touch /var/log/s3_sync.log
      sudo chmod 644 /var/log/s3_sync.log

  setup_log_rotation:
    command: |
      cat <<'LOGROTATE' > /etc/logrotate.d/s3-sync
      /var/log/s3_sync.log {
          weekly
          missingok
          rotate 7
          compress
          delaycompress
          notifempty
      }
      LOGROTATE
