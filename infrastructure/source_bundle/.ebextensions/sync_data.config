commands:
  sync_s3_bucket:
    command: aws s3 sync s3://$(/opt/elasticbeanstalk/bin/get-config environment -k S3_BUCKET_NAME) /var/app/data/api

  create_sync_script:
      command: |
        cat <<'SCRIPT' > /usr/local/bin/sync_s3_data.sh
        #!/bin/bash

        echo "Starting S3 sync..."

        # Sync S3 bucket to local directory
        if aws s3 sync $(/opt/elasticbeanstalk/bin/get-config environment -k S3_BUCKET_NAME) /var/app/data/api; then
            echo "S3 sync completed successfully"
        else
            echo "S3 sync failed with exit code $?"
        fi
        SCRIPT

        chmod +x /usr/local/bin/sync_s3_data.sh

  setup_cron_job:
    command: |
      # Create cron job to sync every 10 minutes
      echo "*/10 * * * * root /usr/local/bin/sync_s3_data.sh" > /etc/cron.d/s3-sync
      chmod 0644 /etc/cron.d/s3-sync

      # Ensure cron service is running
      sudo service cron start
      sudo systemctl enable cron
